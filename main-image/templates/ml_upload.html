{% extends "ml_layout.html" -%}
{% block css -%}
<link href="https://static.deretdata.com/vendors/datatables.net-dt/css/jquery.dataTables.min.css" rel="stylesheet" type="text/css" />
<link href="https://static.deretdata.com/vendors/datatables.net-responsive-dt/css/responsive.dataTables.min.css" rel="stylesheet" type="text/css" />
{%- endblock css %}
{% block content -%}
<div class="container-fluid px-xxl-65 px-xl-20">
    <br/>
    <div class="hk-pg-header">
        <h4 class="hk-pg-title" style="margin-top: 10px">Upload Data</h4>
    </div>
    <div class="row">
        <div class="col-sm-8">
            <button class="btn btn-info btn-rounded dropdown-toggle" data-toggle="dropdown">
                New Data <span class="caret"></span>
            </button>
            <div role="menu" class="dropdown-menu" style="will-change: transform;">
                <a class="dropdown-item" href="javascript:void(0)" id="upload-data">Upload</a>
                <a class="dropdown-item" href="#">Select Existing</a>
                <a class="dropdown-item" href="#">Import From DB</a>
            </div>
        </div>
        <div class="col-sm-4">
            <input type="hidden" id="appid" value="{{app.data_folder}}"/>
            <select class="form-control" id="datalist">
                {%for file in app.files %}
                <option value="{{file.name.split(' !~! ')[1]}}">{{file.name.split(' !~! ')[0]}}</option>
                {%endfor%}
            </select>
        </div>
        <div class="col-sm-12">
            <br/>
            <br/>
            <div class="table-wrap">
                <table id="datable" class="table table-hover w-100 display">
                    <thead>
                        <tr id="datatable-head">
                            <th>Dummy</th>
                        </tr>
                    </thead>
                </table>
                Note: Show Only Data With Non Null Value
            </div>
        </div>
    </div>
    <div style="display: none">
        <form action="/ml_do_upload/{{app.data_folder}}" enctype="multipart/form-data" method="post" id="csv-form">
            <input name="csv" type="file" accept=".xls,.xlsx,.csv" id="upload-csv" />
        </form>
    </div>
</div>
{%- endblock content %}
{% block script -%}
<script src="https://static.deretdata.com/vendors/datatables.net/js/jquery.dataTables.min.js"></script>
<script src="https://static.deretdata.com/vendors/datatables.net-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="https://static.deretdata.com/vendors/datatables.net-dt/js/dataTables.dataTables.min.js"></script>
<script src="https://static.deretdata.com/vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
<script src="https://static.deretdata.com/vendors/datatables.net-buttons-bs4/js/buttons.bootstrap4.min.js"></script>
<script src="https://static.deretdata.com/vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        $('#datable').hide()
        $('#upload-data').on('click',function (e) {
            $('#upload-csv').click()
        });
        $('#upload-csv').on('change',function (e) {
            $('#csv-form').submit()
        });
        $('#datalist').on('change',function (data) {
            loadTable()
        })
        $('#csv-form').on('submit', function(e){
            e.preventDefault();
            var form = e.target;
            var data = new FormData(form);
            $.ajax({
                url: form.action,
                method: form.method,
                contentType: false,
                data: data,
                processData: false,
                beforeSend: function(e){
                    $('#loader').show()
                }
            }).done(function (data) {
                $('#loader').hide()
                console.log(data)
            })
        })
        loadTable()
    });
    function loadTable() {
        datalist=$('#datalist').val()
        $('#datable').hide()
        if(typeof datalist!='undefined' || datalist!='') {
            $.ajax({
                url: "/ml_get_field/"+$('#appid').val()+"/" +datalist,
                success: function (data) {
                    $('#datable').show()
                    var table=$('#datable').DataTable();
                    table.destroy()
                    var field=JSON.parse(data)
                    $('#datatable-head').html("")
                    var columnDt=[]
                    $.each(field,function (x) {
                        $('#datatable-head').append("<th>"+field[x]+"</th>")
                        columnDt.push({data: field[x],name: field[x],orderable: true})
                    })
                    $('#datable').DataTable({
                        bPaginate: true,
                        info:     false,
                        bFilter:     false,
                        serverSide: true,
                        ajax: {
                            url: "/ml_get_data/"+$('#appid').val()+"/" +datalist ,
                                dataSrc: 'data',
                                type: 'GET',
                                data: function (args) {
                                    return {
                                        "args": JSON.stringify(args)
                                    };
                            }
                        },
                        columns: columnDt
                    });
                }
            })
        }
    }
</script>
{%- endblock script %}
